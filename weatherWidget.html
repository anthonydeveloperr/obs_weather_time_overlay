<!doctype html>
<!--
weatherWidget with time overlay for OBS
Author: Norman Gholson IV 2022
requires free OpenWeatherMap account with private API Key
https://openweathermap.org/
-->
<html><head><script>
// ------------------------------------------------CHANGE THESE SETTINGS ----------------------------------------------- */

var yourApiKey = "CHANGE_ME";				// your OpenWeatherMap Api key here
var yourCity = "CHANGE_ME";					// your city name, ex: "London, UK" or "Las Vegas, NV, US" 
var yourUnits = "imperial";					// 'imperial' for fahrenheit  'metric' for celsius  'standard' for kelvin.
var weatherDisplay = "full";				// options: "full" , "weather", "simple" , "temp" , "time" (if blank or error, default is "full")
var weatherIcons = 1;						// show Weather status icons in display 1=on  0=off
var iconHeight = "22px";					// weather icon height (i find it is best at textSize+2)
var textSize = "20pt";						// font size
var textColor = "black";					// font color
var displayWidth = "850px";					// weather display box width
var weatherBackground = "lightgrey";		// weather Background color  (if dynamicBackground is enabled it only applies during daytime hours)
var dynamicBackground = 1;					// weather background changes based on day or night 1=on 0=off
var clockSeperator = "";					// optional: seperator for the temp and time in full mode only (ex: -, /, ., *, additional spaces, etc.)

</script><style> 

.weather-box {
	border: 1px solid #000;
	border-radius:5px;
	text-align:center;
	font-family:tahoma;
	font-weight:bold;

/* ---------------------------------------------  NO CHANGES BELOW HERE  ----------------------------------------------- */
	
color:var(--txtColor); width:var(--dispWidth); background:var(--wBack); font-size:var(--txtSize); }
:root{ --txtSize:;--txtColor:;--dispWidth:;--wBack:; }
body { background: rgba(0,0,0,0); }
</style></head><body>
<script src="jquery.js"></script><center><pre class="weather-box" id="id-weather"></pre></center><script>
var language = window.navigator.userLanguage || window.navigator.language;
const regionTranslate = new Intl.DisplayNames([language], { type: 'region' });
document.querySelector(':root').style.setProperty('--txtSize', textSize);document.querySelector(':root').style.setProperty('--txtColor', textColor);
document.querySelector(':root').style.setProperty('--dispWidth', displayWidth);document.querySelector(':root').style.setProperty('--wBack', weatherBackground);
refreshData();
function weatherCheck() {
	var time = currentTime(new Date());
	$.ajax({
	url: 'https://api.openweathermap.org/data/2.5/weather',
	data:{units: `${yourUnits}`, q: `${yourCity}`, appid: `${yourApiKey}`, lang: `${language}`},
	dataType: 'json',
	success: function(apiResponse) {
	if (dynamicBackground == 1){
	if(apiResponse.weather[0].icon.slice(2) == "n") { document.querySelector(':root').style.setProperty('--wBack', "linear-gradient(to bottom, black , dimgrey");document.querySelector(':root').style.setProperty('--txtColor', "white");}
	if(apiResponse.weather[0].icon.slice(2) == "d") { document.querySelector(':root').style.setProperty('--wBack', "linear-gradient(to bottom, skyblue ,"+weatherBackground);document.querySelector(':root').style.setProperty('--txtColor', "black");}
	}
	var curtemp = Math.round(apiResponse.main.temp);
	var wimg="./images/"+apiResponse.weather[0].icon +".png";
	$.ajax({
	url:'http://api.openweathermap.org/geo/1.0/direct',
	data:{ q: `${apiResponse.name}`, appid: `${yourApiKey}` },
	dataType: 'json',
	success: function(geoResponse) {
	if (geoResponse[0].state == apiResponse.name || geoResponse[0].state == null ) { 
		geoResponse[0].state = regionTranslate.of(geoResponse[0].country);
		}
	if (weatherDisplay.toLowerCase() == "temp") {
	if (weatherIcons == 1){document.getElementById("id-weather").innerHTML = `<img style='height: ${iconHeight};' src=${wimg}> ${curtemp}&deg;`;return; }
	document.getElementById("id-weather").innerHTML = `${curtemp}&deg;`;return;} 
	if (weatherDisplay.toLowerCase() == "time") {document.getElementById("id-weather").innerHTML = `${time}`;return;} 
	if (weatherDisplay.toLowerCase() == "simple"){
	if (weatherIcons == 1){	document.getElementById("id-weather").innerHTML = `${curtemp}&deg; <img style='height: ${iconHeight};' src=${wimg}> ${time}`; return; }
	document.getElementById("id-weather").innerHTML = `${curtemp}&deg;  ${time}`; return;
	} 
	if (weatherDisplay.toLowerCase() == "weather"){
		if (weatherIcons == 1){
			document.getElementById("id-weather").innerHTML = `${geoResponse[0].name}, ${geoResponse[0].state}: ${curtemp}&deg; <img style='height: ${iconHeight};' src=${wimg}> ${apiResponse.weather[0].description }`;
			} else { document.getElementById("id-weather").innerHTML = `${geoResponse[0].name}, ${geoResponse[0].state}: ${curtemp}&deg; \/ ${apiResponse.weather[0].description }`; }
	return;}
	//start of full
	if (weatherIcons == 1){
	document.getElementById("id-weather").innerHTML = `${geoResponse[0].name}, ${geoResponse[0].state}: ${curtemp}&deg; <img style='height: ${iconHeight};' src=${wimg}> ${apiResponse.weather[0].description } ${clockSeperator} ${time}`;
	} else { document.getElementById("id-weather").innerHTML = `${geoResponse[0].name}, ${geoResponse[0].state}: ${curtemp}&deg; \/ ${apiResponse.weather[0].description } ${clockSeperator} ${time}`; }
	}});
}});
}
function currentTime(date){                                                             
	var hours = date.getHours();                                                   
	var minutes = date.getMinutes();                                               
	var isAmPm = hours >= 12 ? 'PM' : 'AM';
	hours = hours % 12;
	hours = hours ? hours : 12;                                                    
	minutes = minutes < 10 ? '0'+ minutes : minutes;
	var curTime = hours + ':' + minutes + ' ' + isAmPm;
	return curTime;
}
function refreshData() {
	weatherCheck();
	setTimeout(refreshData, 60000);
}
</script></body></html>
